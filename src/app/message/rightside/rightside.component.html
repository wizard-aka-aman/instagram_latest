<div class="d-flex flex-column h-100 text-white bg-black">

  <div *ngIf="noUserSelected" class="h-100 d-flex justify-content-center flex-column align-items-center">
    <i style="font-size:100px;" class=" fa-regular fa-message"></i>
    <p class="fs-4">Your messages</p>
    <p class="fs-6">Send a message to start a chat.</p>
    <div class="btn btn-primary p-1 rounded-3 px-3 " data-bs-toggle="modal" data-bs-target="#message">Send Message</div>
  </div>
  <!-- Chat Header -->
  <div *ngIf="!noUserSelected" class="p-3 border-bottom d-flex align-items-center justify-content-start"
    style="border-color: rgb(39, 39, 39)!important; border-width: 1px !important; ">
    <!-- Mobile Back Button -->
    <button class="btn btn-sm  text-white" (click)="goBack()">
      <i class="fa fa-arrow-left"></i>
    </button>

    <div class="search-item d-flex align-items-center  p-2  ">
      <img [src]="getProfileImage(profilePicture) || 'assets/avatar.png'" class="rounded-circle mx-3" width="40"
        height="40" style="object-fit: cover; cursor: pointer;" routerLink="/{{groupName}}" />
      <div>
        <div class="fw-bold text-white" routerLink="/{{groupName}}" style="cursor: pointer;">{{ groupName }}</div>
        <div class=" small">{{ fullName }}</div>
      </div>
    </div>
    <div class="d-md-none" style="width: 30px;"></div> <!-- placeholder -->
  </div>

  <!-- Messages Wrapper -->
  <div [ngClass]="noUserSelected ? '':'messages-wrapper'" #scrollContainer>

    <div *ngFor="let msg of messages; let i = index">
      
      <!-- Date Separator -->
      <div *ngIf="shouldShowDateSeparator(msg, messages[i-1])" class="date-separator">
        <span class="date-separator-text">{{ formatDateSeparator(msg.sentAt)}}</span>
      </div>

      <div class="mb-2 message-text position-relative"
        [class.text-end]="msg.groupName === user">

        <!-- Emoji Button for Sender -->
        <div class="overlay" (click)="toggleEmojiPicker(msg.id)" *ngIf="msg.groupName === user">
          <i class="fa-regular fa-face-smile"></i>
        </div>
        <div *ngIf="msg.reaction &&  msg.groupName === user" class=" ">
          <span class="emoji fs-6">{{ msg.reaction }}</span>
        </div>
        <!-- 3-dot Menu Button -->
        <div class="menu position-relative" *ngIf="msg.groupName === user" (click)="toggleMenu(msg.id)">
          <i class="fa-solid fa-ellipsis-vertical"></i>

          <!-- Dropdown -->
          <div *ngIf="menuOpenId === msg.id" class="dropdown-menu-custom position-absolute end-0 p-2 rounded shadow">
            <div class="dropdown-item" (click)="copyMessage(msg)">
              <i class="fa-regular fa-copy me-2 "></i>Copy
            </div>
            <div class="dropdown-item text-danger" (click)="unsendMessage(msg.id)">
              <i class="fa-regular fa-trash-can me-2"></i>Unsend
            </div>
          </div>
        </div>


        <!-- Message Bubble -->
        <div class="d-inline-block fs-small px-2 py-1 rounded-5 position-relative"
          [ngClass]="{'mytext': msg.groupName === user, 'othertext': msg.groupName !== user}"
          style="max-width: 70%; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; text-align: left;">

          <!-- Simple Text Message (no post, no reel, no file) -->
          <span
            *ngIf="msg.postLink == null && msg.reelPublicId == null && (msg.message !== 'Shared a file' || msg.mediaUrl == null)"
            [innerHTML]="formatMessageWithLinks(msg.message)">
          </span>

          <!-- Post / Reel Section -->
          <div *ngIf="(msg.postLink != null || msg.reelPublicId != null) && msg.message !== 'Shared a file'"
            class="card shadow-sm border-0 rounded-3"
            style="max-width: 100%; width: 100%; background-color: transparent;">

            <!-- Header: profile image + username -->
            <div class="d-flex align-items-center p-2">
              <img [src]="getProfileImage(msg.profilePicture)" routerLink="/{{msg.usernameOfPostReel}}"
                class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;" />
              <div>
                <strong style="color: white;">{{ msg.usernameOfPostReel }}</strong>
              </div>
            </div>

            <!-- Post Image -->
            <ng-container *ngIf="msg.postLink">
              <img [src]="getProfileImage(msg.postLink)" routerLink="/{{msg.usernameOfPostReel}}/p/{{msg.postId}}"
                class="card-img-top rounded-3" alt="media preview"
                style="object-fit: cover; max-height: 300px; width: 100%;" />
            </ng-container>

            <!-- Reel Video -->
            <ng-container *ngIf="msg.reelPublicId">
              <video [src]="msg.mediaUrl" routerLink="/{{msg.usernameOfPostReel}}/reel/{{msg.reelPublicId}}"
                class="post-media card-img-top rounded-3" muted loop playsinline
                style="object-fit: cover; max-height: 400px; width: 100%;">
              </video>
            </ng-container>

            <!-- Caption -->
            <div class="card-body p-2" *ngIf="msg.message !== 'Voice Message' && !msg.mediaUrl">
              <p class="card-text mb-1 text-white">
                {{ msg.message }}
              </p>
            </div>
          </div>
          <div *ngIf="msg.message === 'Voice Message' && msg.mediaUrl" class="audio-wrapper">
            <audio [src]="msg.mediaUrl" controls class="audio-player"></audio>
          </div>
          <!-- File Section (Shared a file) -->
          <ng-container *ngIf="msg.message === 'Shared a file' && msg.mediaUrl != null">

            <!-- IMAGE PREVIEW -->
            <img *ngIf="isImage(msg?.mediaUrl)" [src]="msg.mediaUrl" class="rounded mt-1"
              style="max-width:200px; max-height:200px; object-fit:cover; cursor:pointer;" (click)="downloadFile(msg)" />

            <!-- VIDEO PREVIEW -->
            <video *ngIf="isVideo(msg?.mediaUrl)" [src]="msg.mediaUrl" controls class="mt-1"
              style="max-width:250px; max-height:250px; object-fit:cover; cursor:pointer;">
            </video>

            <!-- OTHER FILE TYPES (txt, zip, pdf, docx, etc.) -->
            <div *ngIf="!isImage(msg?.mediaUrl) && !isVideo(msg?.mediaUrl)"
              class="d-flex align-items-center p-2 rounded text-white mt-1" style="cursor: pointer;"
              (click)="downloadFile(msg)">
              <i class="fa-solid fa-file fs-4 me-2"></i>
              <span>{{ getFileName(msg.mediaUrl) }}</span>
            </div>

          </ng-container>

          <!-- Message Timestamp -->
          <div class="message-time">
            {{ formatMessageTime(msg.sentAt) }}
          </div>

        </div>
        <div *ngIf="msg.reaction && msg.groupName !== user" class=" ">
          <span class="emoji fs-6">{{ msg.reaction }}</span>
        </div>

        <!-- Copy Button for Receiver -->
        <div class="overlay" (click)="copyMessage(msg)" *ngIf="msg.groupName !== user">
          <i class="fa-regular fa-copy"></i>
        </div>

        <!-- Emoji Button for Receiver -->
        <div class="overlay" (click)="toggleEmojiPicker(msg.id)" *ngIf="msg.groupName !== user">
          <i class="fa-regular fa-face-smile"></i>
        </div>


        <!-- Emoji Picker -->
        <div *ngIf="emojiPickerIndex === msg.id"
          class="emoji-picker-container position-absolute bg-light rounded shadow p-2">
          <span *ngIf="msg.reaction">
            <span class="emoji" *ngFor="let emoji of emojis" (click)="addEmojiToMessage(msg.id, emoji)">
              {{ emoji }}
            </span>
          </span>
          <span *ngIf="!msg.reaction">
            <span class="emoji" *ngFor="let emoji of emojisWithoutRemove" (click)="addEmojiToMessage(msg.id, emoji)">
              {{ emoji }}
            </span>
          </span>
        </div>

      </div>
    </div>

  </div>




  <div *ngIf="selectedFile" class="mb-3 p-2 border rounded text-white d-flex">

    <!-- IMAGE PREVIEW -->
    <img *ngIf="selectedFileUrl && selectedFile.type.startsWith('image/')" [src]="selectedFileUrl" class="rounded"
      style="max-width: 150px; max-height: 150px; object-fit: cover;" />

    <!-- VIDEO PREVIEW -->
    <video *ngIf="selectedFileUrl && selectedFile.type.startsWith('video/')" [src]="selectedFileUrl" controls
      style="max-width: 200px; max-height: 200px;">
    </video>

    <!-- OTHER FILES (txt, zip, pdf, docx, etc) -->
    <div *ngIf="!selectedFileUrl" class="d-flex align-items-center">
      <i class="fa-solid fa-file fs-4 me-2"></i>
      <span>{{ selectedFileName }}</span>
    </div>
 
      <!-- Remove Button -->
    <div class="text-danger mt-2" style="cursor:pointer" (click)="clearSelectedFile()">
      Remove
    </div>
    <!-- Send Button -->
    <div class="text-primary mt-2 ms-4" style="cursor:pointer" (click)="send()">
      Send
    </div> 

  </div> 
<!-- Recording Indicator -->
<div *ngIf="isRecording" class="recording-indicator">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-2">
      <div class="recording-pulse"></div>
      <span class="fw-medium">Recording...</span>
    </div>
    <span class="recording-time">{{ recordingDuration | number:'1.0-0' }}s / 60s</span>
  </div>
  <div class="recording-progress-bar">
    <div class="recording-progress-fill" [style.width.%]="(recordingDuration / 60) * 100"></div>
  </div>
</div>

<!-- Processing Audio Loader -->
<div *ngIf="isProcessingAudio" class="audio-processing">
  <div class="d-flex align-items-center gap-2">
    <i class="fa fa-spinner fa-spin text-primary"></i>
    <span>Processing audio...</span>
  </div>
</div>

<!-- Audio Preview (After Recording) -->
<div *ngIf="audioUrl && !isRecording && !isProcessingAudio" class="audio-preview">
  <div class="audio-preview-content">
    <div class="audio-waveform">
      <i class="fa-solid fa-microphone-lines fs-4 text-primary me-3"></i>
      <audio [src]="audioUrl" controls class="audio-player"></audio>
    </div>
    <div class="audio-preview-actions">
      <button class="btn btn-success px-4" [disabled]="isSendAudio" (click)="sendRecordedAudio()">
        <i class="fa-solid fa-paper-plane me-2"></i>Send
      </button>
      <button class="btn btn-outline-danger" (click)="cancelRecordedAudio()">
        <i class="fa-solid fa-trash"></i>
      </button>
    </div>
  </div>
</div>

<!-- Message Input Area -->
<div *ngIf="!noUserSelected" class="p-3 border-top mb-5"
     style="border-color: rgb(39, 39, 39)!important; border-width: 1px !important;">

  <form (ngSubmit)="send()">
    <div class="input-group position-relative d-flex align-items-end">
      <div class="input-wrapper flex-grow-1">
        <textarea class="chat-input" 
                  [(ngModel)]="newMessage" 
                  name="message"
                  (input)="autoResize($event)"
                  (keydown.enter)="handleEnterKey($event)" 
                  placeholder="Type a message..."
                  [disabled]="isRecording || isProcessingAudio"></textarea>
      </div>

      <!-- Hidden File Input -->
      <input type="file" #fileInput (change)="onFileSelected($event)" style="display:none;" />

      <!-- Plus (Add File) Button - Disabled when recording or audio preview -->
      <button type="button" 
              class="btn text-primary input-btn-left"
              (click)="fileInput.click()"
              [disabled]="isRecording || isProcessingAudio || audioUrl">
        <i class="fa-regular fa-plus fs-5"></i>
      </button>

      <!-- Mic Button - Show when no message and no audio preview -->
      <button *ngIf="(!newMessage || newMessage.trim() === '') && !audioUrl"
              type="button"
              class="btn input-btn-right ms-5"
              
              [disabled]="isUploadingFile || isProcessingAudio"
              (click)="toggleRecording()">
        <i *ngIf="!isProcessingAudio"
           [class.fa-microphone]="!isRecording"
           [class.fa-stop-circle]="isRecording"
           [class.recording-pulse]="isRecording"
           [class.recording-active]="isRecording"
           class="fa-solid fs-5 text-white"
           [style.color]="isRecording ? '#ff4444' : ''"></i>
        <i *ngIf="isProcessingAudio" class="fa fa-spinner fa-spin"></i>
      </button>

      <!-- Send Button - Show only when message is NOT empty -->
      <button *ngIf="newMessage && newMessage.trim() !== '' && !audioUrl"
              type="submit"
              class="btn text-primary input-btn-right"
              [disabled]="isUploadingFile || isRecording || isProcessingAudio">
        <span *ngIf="!isUploadingFile">Send</span>
        <span *ngIf="isUploadingFile">
          <i class="fa fa-spinner fa-spin"></i>
        </span>
      </button>

    </div>
  </form>
</div>


</div>
<!-- Custom Microphone Permission Popup -->
<div *ngIf="showMicPermissionPopup" class="mic-permission-overlay">
  <div class="mic-box">
    <i class="fa-solid fa-microphone-slash mic-icon"></i>
    <h3>Microphone Permission Needed</h3>
    <p>To record voice messages, please allow microphone access.</p>
    <button class="btn btn-primary" (click)="openBrowserSettings()">
      Open Browser Settings
    </button>
    <button class="btn btn-secondary mt-2" (click)="closeMicPopup()">
      Cancel
    </button>
  </div>
</div>