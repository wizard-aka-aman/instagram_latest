<div class="reels-container">
  <div class="reels-wrapper">

    <div class="reel-item" *ngFor="let reel of reels; let i = index">
      
      <div class="video-wrapper">
        <video
          playsinline
          webkit-playsinline
          muted
          autoplay
          loop
          (click)="StopAndPlayVideo(videoPlayer)"
          (contextmenu)="DisableDownload($event)"
          #videoPlayer
          [src]="reel.url"
          class="reel-video"
        ></video>

        <div class="video-gradient"></div>

        <div class="action-buttons">
          <div class="action-item">
            <button 
              class="action-btn"
              (click)="reel.isLikedLoggedInUser ? Like(reel, reel.isLikedLoggedInUser,false) : Like(reel, reel.isLikedLoggedInUser,true)"
            >
              <i 
                [class]="reel.isLikedLoggedInUser ? 'fa-solid fa-heart liked' : 'fa-regular fa-heart'"
              ></i>
            </button>
            <span 
              class="action-count" 
              data-bs-toggle="modal" 
              data-bs-target="#ReelHomeLikes" 
              (click)="ToogleLike(reel)"
            >
              {{ reel.likesCount | number }}
            </span>
          </div>

          <div class="action-item">
            <button class="action-btn" (click)="toggleComments(reel, $event)">
              <i class="fa-regular fa-comment"></i>
            </button>
            <span class="action-count">{{ reel.commentsCount | number }}</span>
          </div>

          <div class="action-item">
            <button 
              class="action-btn" 
              data-bs-toggle="modal" 
              data-bs-target="#HomeSent" 
              (click)="AddPublicId(reel)"
            >
              <i class="fa-regular fa-paper-plane"></i>
            </button>
          </div>

          <div class="action-item">
            <button class="action-btn">
              <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
          </div>
        </div>

        <div class="reel-info">
          <div class="user-section">
            <img 
              [src]="getProfileImage(reel.profilePicture)" 
              routerLink="/{{reel.userName}}" 
              alt="Profile" 
              class="profile-pic"
            >
            <div class="user-details">
              <div class="username-row">
                <strong class="username" routerLink="/{{reel.userName}}">{{ reel.userName }}</strong>
                <button 
                  *ngIf="LoggedInUser != reel.userName && !reel.alreadyFollowing && !reel.isRequested"
                  (click)="Follow(reel)" 
                  class="follow-btn"
                >
                  {{ reel.isSeenUserFollwingMeVariable ? 'Follow Back' : 'Follow' }}
                </button>
                <button 
                  *ngIf="LoggedInUser != reel.userName && reel.isRequested" 
                  (click)="RemoveRequest(reel)" 
                  class="follow-btn requested"
                >
                  Requested
                </button>
                <button 
                  *ngIf="LoggedInUser != reel.userName && reel.alreadyFollowing"
                  (click)="UnFollow(reel)" 
                  class="follow-btn following"
                >
                  Following
                </button>
              </div>
              <p class="description" [class.expanded]="reel.showFullDescription">
                {{ reel.descripton }}
                <span 
                  *ngIf="reel.descripton?.length > 100" 
                  class="more-btn"
                  (click)="reel.showFullDescription = !reel.showFullDescription"
                >
                  {{ reel.showFullDescription ? 'less' : 'more' }}
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="reel.showComments" class="comments-overlay" (click)="onDocumentClick($event)">
  <div class="comments-panel" (click)="$event.stopPropagation()" id="comment-box-{{i}}">
    
    <div class="comments-header draggable-area"
         (touchstart)="onHeaderTouchStart($event, reel)"
         (touchmove)="onHeaderTouchMove($event, reel)"
         (touchend)="onDragEnd($event, reel)"
         (mousedown)="onDragStart($event, reel)"
         (mousemove)="onDragMove($event, reel)"
         (mouseup)="onDragEnd($event, reel)"
         (mouseleave)="onDragEnd($event, reel)">
      
      <div class="drag-handle"></div>
      
      <h3>Comments</h3>
      <button class="close-btn" (click)="toggleComments(reel, $event)">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="comments-list" #chatContainer>
      <div *ngFor="let comment of reel.comments" class="comment-item">
        <img 
          [src]="getProfileImage(comment.profilePicture)" 
          routerLink="/{{comment.userName}}" 
          alt="Profile" 
          class="comment-avatar"
        >
        <div class="comment-content">
          <div class="comment-header">
            <strong class="comment-username">{{ comment.userName }}</strong>
            <span class="comment-time">{{ comment.commentedAt | date : "medium"  }}</span>
          </div>
          <p class="comment-text">{{ comment.commentText }}</p>
        </div>
      </div>

      <div *ngIf="!reel.comments || reel.comments.length === 0" class="empty-comments">
        <i class="fa-regular fa-comment"></i>
        <p>No comments yet</p>
        <span>Be the first to comment</span>
      </div>
    </div>

    <div class="comment-input-wrapper">
      <img 
        [src]="getProfileImage(this.profilePicture)" 
        alt="Your profile" 
        class="input-avatar"
      >
      <input 
        [(ngModel)]="reel.newComment" 
        class="comment-input" 
        placeholder="Add a comment..." 
        (keydown.enter)="postComment(reel)"
      />
      <button 
        class="post-btn" 
        [disabled]="!reel.newComment?.trim()"
        (click)="postComment(reel)"
      >
        Post
      </button>
    </div>
  </div>
</div>

    </div>
  </div>
</div>

<div class="modal fade" id="HomeSent" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content instagram-modal">
      
      <div class="modal-header">
        <h5 class="modal-title">Share</h5>
        <button 
          type="button" 
          class="btn-close" 
          (click)="ClearSearchQuery()" 
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-search">
        <div class="search-input-group">
          <i class="fa-solid fa-magnifying-glass search-icon"></i>
          <input 
            type="text" 
            (input)="DeBounce()" 
            [(ngModel)]="searchQuery"
            placeholder="Search..."
            class="search-input"
          >
        </div>
      </div>

      <div class="modal-body">
        <div 
          *ngFor="let user of searchResults" 
          class="share-user-item"
          (click)="SendPost(user.userName)" 
          data-bs-dismiss="modal"
        >
          <img 
            [src]="getProfileImage(user.profilePicture)" 
            alt="User" 
            class="share-user-avatar"
          />
          <span class="share-username">{{ user.userName }}</span>
          <button class="send-btn">
            <i class="fa-regular fa-paper-plane"></i>
          </button>
        </div>

        <div *ngIf="searchResults.length === 0 && searchQuery" class="empty-search">
          <p>No results found</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ReelHomeLikes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content instagram-modal">
      
      <div class="modal-header">
        <h5 class="modal-title">Likes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div 
          *ngFor="let like of selectedLikes" 
          class="like-user-item"
          data-bs-dismiss="modal"
          [routerLink]="['/', like.userName]"
        >
          <img 
            [src]="getProfileImage(like.profilePicture)" 
            alt="User" 
            class="like-user-avatar"
          />
          <span class="like-username">{{ like.userName }}</span>
        </div>

        <div *ngIf="!selectedLikes || selectedLikes.length === 0" class="empty-likes">
          <i class="fa-regular fa-heart"></i>
          <p>No likes yet</p>
        </div>
      </div>
    </div>
  </div>
</div>